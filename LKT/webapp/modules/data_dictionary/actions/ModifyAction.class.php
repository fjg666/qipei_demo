<?phprequire_once(MO_LIB_DIR . '/DBAction.class.php');require_once(MO_LIB_DIR . '/JurisdictionAction.class.php');require_once(MO_LIB_DIR . '/LaiKeLogUtils.class.php');class ModifyAction extends Action {    /**     * <p>Copyright (c) 2018-2019</p>     * <p>Company: www.laiketui.com</p>     * @author 段宏波     * @date 2018/12/12  18:54     * @version 1.0     */	public function getDefaultView() {        $db = DBAction::getInstance();        $request = $this->getContext()->getRequest();        // 接收信息        $id = intval($request->getParameter("id")); // 轮播图id        $sql0 = "select a.*,b.name from lkt_data_dictionary_list as a left join lkt_data_dictionary_name as b on a.sid = b.id where a.id = '$id'";        $r0 = $db->select($sql0);        if($r0){            $code = $r0[0]->code;            $name = $r0[0]->name;            $s_name = $r0[0]->s_name;            $value = $r0[0]->value;            $text = $r0[0]->text;            $status = $r0[0]->status;        }        $sql1 = "select id,name from lkt_data_dictionary_name where status = 1 and recycle = 0 ";        $r1 = $db->select($sql1);        $request->setAttribute('id', $id);        $request->setAttribute('code', $code);        $request->setAttribute('name', $name);        $request->setAttribute('s_name', $s_name);        $request->setAttribute('value', $value);        $request->setAttribute('text', $text);        $request->setAttribute('status', $status);        $request->setAttribute('data_dictionary_list', $r1);        return View :: INPUT;	}    /**     * <p>Copyright (c) 2018-2019</p>     * <p>Company: www.laiketui.com</p>     * @author 段宏波     * @date 2018/12/12  18:54     * @version 1.0     */	public function execute(){		$db = DBAction::getInstance();        $JurisdictionAction = new JurisdictionAction();        $lktlog = new LaiKeLogUtils("common/data_dictionary.log");        // 1.开启事务        $db->begin();		$request = $this->getContext()->getRequest();        $store_id = $this->getContext()->getStorage()->read('store_id');        $admin_name = $this->getContext()->getStorage()->read('admin_name');        // 接收信息		$id = intval($request->getParameter('id'));        $code = addslashes($request->getParameter('code')); // 数据编码        $data_dictionary_id = addslashes($request->getParameter('data_dictionary_id')); // 数据名称        $subordinate_name = addslashes($request->getParameter('name')); // 所属属性名称        $value = addslashes($request->getParameter('value')); // value        $text = addslashes($request->getParameter('text')); // 值        $status = addslashes($request->getParameter('status')); // 是否生效        if($code == ''){            echo json_encode(array('status' =>'数据编码不能为空！' ));exit;        }else{            $sql0 = "select id from lkt_data_dictionary where code = '$code' and recycle = 0 and id != '$id'";            $r0 = $db->select($sql0);            if($r0){                echo json_encode(array('status' =>'数据编码'.$code.'已存在！' ));exit;            }        }        if($data_dictionary_id == '' || $data_dictionary_id == 0){            echo json_encode(array('status' =>'请选择数据名称！' ));exit;        }        $sql1 = "select name from lkt_data_dictionary_name where id = '$data_dictionary_id' and recycle = 0";        $r1 = $db->select($sql1);        if($r1){            $name = $r1[0]->name;            if($name == '属性名' || $name == '属性值'){                $rew = explode('_',$code);                $value = (int)$rew[2];            }        }else{            echo json_encode(array('status' =>'参数错误！' ));exit;        }        $sql1_1 = "select * from lkt_data_dictionary_list where recycle = 0 and sid = '$data_dictionary_id' and value = '$value' and id != '$id'";        $r1_1 = $db->select($sql1_1);        if($r1_1){            echo json_encode(array('status' =>'code重复！' ));exit;        }        if($text == ''){            echo json_encode(array('status' =>'值不能为空！' ));exit;        }else{            if($name == '属性值'){                if($subordinate_name == '' || $subordinate_name == 0){                    echo json_encode(array('status' =>'请选择属性名称！' ));exit;                }                $sql2_0 = "select text from lkt_data_dictionary_list where id = '$subordinate_name'";                $r2_0 = $db->select($sql2_0);                $s_name = $r2_0[0]->text;                $sql2 = "select * from lkt_data_dictionary_list where recycle = 0 and sid = '$data_dictionary_id' and s_name = '$s_name' and text = '$text' and id != '$id'";                $r2 = $db->select($sql2);                if($r2){                    echo json_encode(array('status' =>'值'.$text.'已存在！' ));exit;                }                $sql3 = "update lkt_data_dictionary_list set code = '$code',sid = '$data_dictionary_id',s_name = '$s_name',value = '$value',text = '$text',status = '$status',admin_name = '$admin_name',add_date = CURRENT_TIMESTAMP where id = '$id'";            }else{                $sql2 = "select * from lkt_data_dictionary_list where recycle = 0 and sid = '$data_dictionary_id' and text = '$text' and id != '$id'";                $r2 = $db->select($sql2);                if($r2){                    echo json_encode(array('status' =>'值'.$text.'已存在！' ));exit;                }                $sql3 = "update lkt_data_dictionary_list set code = '$code',sid = '$data_dictionary_id',value = '$value',text = '$text',status = '$status',admin_name = '$admin_name',add_date = CURRENT_TIMESTAMP where id = '$id'";            }        }        $r3 = $db->update($sql3);        if($r3 == -1){            $JurisdictionAction->admin_record($store_id,$admin_name,'修改数据字典ID为'.$id.'失败',2);            $Log_content = __METHOD__ . '->' . __LINE__ . ' 修改数据字典ID为'.$id.'失败 ';            $lktlog->customerLog($Log_content);            $db->rollback();            echo json_encode(array('status' => '未知原因，修改失败！'));exit;        }else{            $JurisdictionAction->admin_record($store_id,$admin_name,'修改数据字典ID为'.$id.'成功',2);            $Log_content = __METHOD__ . '->' . __LINE__ . ' 修改数据字典ID为'.$id.'成功 ';            $lktlog->customerLog($Log_content);            $db->commit();            echo json_encode(array('status' =>'修改成功！' ,'suc'=>'1'));exit;        }		return;	}	public function getRequestMethods(){		return Request :: POST;	}}?>