<?phprequire_once(MO_LIB_DIR . '/DBAction.class.php');require_once(MO_LIB_DIR . '/ShowPager.class.php');require_once(MO_LIB_DIR . '/Tools.class.php');require_once(MO_LIB_DIR . '/version.php');class IndexAction extends Action {// getContext() 检索当前应用程序上下文。// getRequest() 检索请求。// getStorage() 检索存储。// setAttribute() 设置一个属性。    // 获取用户名    public function getDefaultView() {        $db=DBAction::getInstance();        $request = $this->getContext()->getRequest();        $admin_id = $this->getContext()->getStorage()->read('admin_id');        $store_id = $this->getContext()->getStorage()->read('store_id');        $version = LKT_VERSION;        $upgrade= $request->getParameter('upgrade');//升级        if($upgrade){            $this->upgrade();        }        //状态查询        $mon = date("Y-m");//当前月份        //得到系统的年月        $tmp_date=date("Ym");        //切割出年份        $tmp_year=substr($tmp_date,0,4);        //切割出月份        $tmp_mon =substr($tmp_date,4,2);        $tmp_forwardmonth=mktime(0,0,0,$tmp_mon-1,1,$tmp_year);        //得到当前月的上一个月        $lastmon=date("Y-m",$tmp_forwardmonth);        //今天        $today = date("Y-m-d");        //包括年份的日期用与sql查询条件        $day_1= date("Y-m-d",strtotime("-1 day"));//昨天        $day_2= date("Y-m-d",strtotime("-2 day"));//2天前        $day_3= date("Y-m-d",strtotime("-3 day"));//3天前        $day_4= date("Y-m-d",strtotime("-4 day"));//4天前        $day_5= date("Y-m-d",strtotime("-5 day"));//5天前        $day_6= date("Y-m-d",strtotime("-6 day"));//6天前        //不包括年份的日期用于前端显示        $today1 = date("m-d");            $day_show_1= date("m-d",strtotime("-1 day")); //昨天        $day_show_2= date("m-d",strtotime("-2 day"));//2天前        $day_show_3= date("m-d",strtotime("-3 day"));//3天前        $day_show_4= date("m-d",strtotime("-4 day"));//4天前        $day_show_5= date("m-d",strtotime("-5 day"));//5天前        $day_show_6= date("m-d",strtotime("-6 day"));//6天前        //--待付款        $dfk_sql = "select num from lkt_order where store_id = '$store_id' and status = 0 and otype != 'pt' ";        $dfk = $db -> selectrow($dfk_sql);        //--待发货        $dfh_sql = "select num from lkt_order where store_id = '$store_id' and status = 1 and otype != 'pt'";        $dp = $db -> selectrow($dfh_sql);        //--待收货        $dsh_sql = "select num from lkt_order where store_id = '$store_id' and status = 2 and otype != 'pt'";        $yth = $db -> selectrow($dsh_sql);        //待评价订单        $pj_sql = "select num from lkt_order where store_id = '$store_id' and status = 3 and otype != 'pt'";        $pj = $db -> selectrow($pj_sql);        //退货订单        $th_sql = "select num from lkt_order where store_id = '$store_id' and status = 4 and otype != 'pt'";        $th = $db -> selectrow($th_sql);        //已完成订单        $wc_sql = "select num from lkt_order where store_id = '$store_id' and status = 5 and otype != 'pt'";        $wc = $db -> selectrow($wc_sql);        //当日的营业额        $day_sql = "select sum(z_price) as z_price         from lkt_order          where store_id = '$store_id' and add_time like '$today%' and status > 0 and status not in(0,7,4,11) and pay_time != ''";        $day01 = $db -> select($day_sql);        $day_yy = $day01[0] -> z_price ? $day01[0] -> z_price : 0;        //当日售后完成的营业额        $day_sql1 = "select sum(z_price) as z_price         from lkt_order as o         left JOIN lkt_order_details as od on o.sNo = od.r_sNo and od.re_type = 3 and r_type = 12        where o.store_id = '$store_id' and o.add_time like '$today%' and o.status = 4 and o.pay_time != ''";        $day02 = $db -> select($day_sql1);        $day_yy2 = $day02[0] -> z_price ? $day02[0] -> z_price : 0;        $day_yy = $day_yy + $day_yy2;        //昨天的营业额        $yessql = "select sum(z_price) as z_price from lkt_order where store_id = '$store_id' and add_time like '$day_1%' and status > 0 and status not in(0,7,4,11) and pay_time != '' ";        $yes01 = $db -> select($yessql);        $yes_yy =$yes01[0] -> z_price ? $yes01[0] -> z_price : 0;        //昨天售后完成的营业额        $yessql = "select sum(z_price) as z_price         from lkt_order as o         left JOIN lkt_order_details as od on o.sNo = od.r_sNo and od.re_type = 3 and r_type = 12        where o.store_id = '$store_id' and o.add_time like '$day_1%' and o.status = 4 and o.pay_time != ''";        $yes02 = $db -> select($yessql);        $yes_yy2 =$yes02[0] -> z_price ? $yes02[0] -> z_price : 0;        $yes_yy = $yes_yy + $yes_yy2;        //营业额百分比(当日减去前一天的值除以前一日的营业额)        if($yes_yy > 0){            $yingye_day = round(($day_yy-$yes_yy)/$yes_yy *100 , 2)."%";        }else{            $yingye_day = '0';        }        //当日的总订单        $day_dd = "select id from lkt_order where store_id = '$store_id' and add_time like '$today%' and status > 0 and status not in(0,7,4,11) and pay_time != '' ";        $daydd = $db -> selectrow($day_dd);        //当日售后完成的总订单        $day_dd1 = "select o.id         from lkt_order as o         left JOIN lkt_order_details as od on o.sNo = od.r_sNo and od.re_type = 3 and r_type = 12        where o.store_id = '$store_id' and o.add_time like '$today%' and o.status = 4 and o.pay_time != '' ";        $daydd1 = $db -> selectrow($day_dd1);        $daydd = $daydd + $daydd1;        //昨天的总订单        $yes_dd = "select id from lkt_order where store_id = '$store_id' and add_time like '$day_1%' and status > 0 and status not in(0,7,4,11) and pay_time != '' ";        $yesdd = $db -> selectrow($yes_dd);        //昨天售后完成的总订单        $yes_dd1 = "select id         from lkt_order as o         left JOIN lkt_order_details as od on o.sNo = od.r_sNo and od.re_type = 3 and r_type = 12        where o.store_id = '$store_id' and o.add_time like '$day_1%' and o.status = 4 and o.pay_time != '' ";        $yesdd1 = $db -> selectrow($yes_dd1);        $yesdd = $yesdd + $yesdd1;        //订单百分比(当日减去前一天的值除以前一日的订单)        if($yesdd > 0){            $dingdan_day = round(($daydd-$yesdd)/$yesdd *100 , 2)."%";        }else{            $dingdan_day = '0';        }        //这个月的营业额        $tyye_sql = "select sum(z_price) as z_price from lkt_order where store_id = '$store_id' and add_time like '$mon%' and status > 0 and status not in(0,7,4,11) and pay_time != '' ";        $tm001 = $db -> select($tyye_sql);        $tm0101 = $tm001[0] -> z_price ;        $tm01 = $tm0101?$tm0101:0;        //这个月售后完成的营业额        $tyye_sql1 = "select sum(z_price) as z_price         from lkt_order as o         left JOIN lkt_order_details as od on o.sNo = od.r_sNo and od.re_type = 3 and r_type = 12        where o.store_id = '$store_id' and o.add_time like '$mon%' and o.status = 4 and o.pay_time != '' ";        $tm002 = $db -> select($tyye_sql1);        $tm0102 = $tm002[0] -> z_price ;        $tm02 = $tm0102?$tm0102:0;        $tm01 = $tm01 + $tm02;        //这个月的总订单        $tm_sql = "select id from lkt_order where store_id = '$store_id' and add_time like '$mon%' and status > 0 and status not in (0,4,7,11) and pay_time != ''";        $tm = $db -> selectrow($tm_sql);        //这个月售后完成的总订单        $tm_sql1 = "select o.id        from lkt_order as o         left JOIN lkt_order_details as od on o.sNo = od.r_sNo and od.re_type = 3 and r_type = 12        where o.store_id = '$store_id' and o.add_time like '$mon%' and o.status = 4 and o.pay_time != '' ";        $tm1 = $db -> selectrow($tm_sql1);        $tm = $tm + $tm1;        //累计营业额        $tyye_sql01 = "select sum(z_price) as z_price from lkt_order where store_id = '$store_id' and status > 0 and status not in (0,4,7,11) and pay_time != ''";        $tm002 = $db -> select($tyye_sql01);        $tm0202 = $tm002[0] -> z_price ;        $tm02 = $tm0202?$tm0202:0;        //累计售后完成的营业额        $tyye_sql02 = "select sum(z_price) as z_price         from lkt_order as o         left JOIN lkt_order_details as od on o.sNo = od.r_sNo and od.re_type = 3 and r_type = 12        where o.store_id = '$store_id' and o.status = 4 and o.pay_time != '' ";        $tm0022 = $db -> select($tyye_sql02);        $tm02022 = $tm0022[0] -> z_price ;        $tm03 = $tm02022?$tm02022:0;        $tm02 = $tm02 + $tm03;        //累计订单数        $latm_sql01 = "select id from lkt_order where store_id = '$store_id' and status > 0 and status not in (0,4,7,11) and pay_time != ''";        $leiji_dd = $db -> selectrow($latm_sql01);        //累计售后完成的订单数        $latm_sql011 = "select o.id         from lkt_order as o         left JOIN lkt_order_details as od on o.sNo = od.r_sNo and od.re_type = 3 and r_type = 12        where o.store_id = '$store_id' and o.status = 4 and o.pay_time != '' ";        $leiji_dd1 = $db -> selectrow($latm_sql011);        $leiji_dd = $leiji_dd + $leiji_dd1;        //会员人数        $sql = "select id from lkt_user where store_id = '$store_id'";        $user_num= $db -> selectrow($sql);//会员总人数        $sql01 = "select id from lkt_user where store_id = '$store_id' and Register_data like '$today%'";        $user_num01= $db -> selectrow($sql01);//今天的注册的会员人数        $sql02 = "select id from lkt_user where store_id = '$store_id' and Register_data like '$day_1%'";        $user_num02= $db -> selectrow($sql02);//昨天注册的会员人数        $sql03 = "select id from lkt_user where store_id = '$store_id' and Register_data like '$day_2%'";        $user_num03= $db -> selectrow($sql03);//2天前注册的会员人数        $sql04 = "select id from lkt_user where store_id = '$store_id' and Register_data like '$day_3%'";        $user_num04= $db -> selectrow($sql04);//3天前注册的会员人数        $sql05 = "select id from lkt_user where store_id = '$store_id' and Register_data like '$day_4%'";        $user_num05= $db -> selectrow($sql05);//4天前注册的会员人数        $sql06 = "select id from lkt_user where store_id = '$store_id' and Register_data like '$day_5%'";        $user_num06= $db -> selectrow($sql06);//5天前注册的会员人数        $sql07 = "select id from lkt_user where store_id = '$store_id' and Register_data like '$day_6%'";        $user_num07= $db -> selectrow($sql07);//6天前注册的会员人数        $notice = "select * from lkt_set_notice where store_id = '$store_id' order by time desc";        $res_notice= $db -> select($notice);//公告        //访客人数        $fangke_sql = "select id from lkt_record where store_id = '$store_id' and type = 0 group by user_id";        $fangke= $db -> selectrow($fangke_sql);        $fangke_sql01 = "select id from lkt_record where store_id = '$store_id' and add_date like '$today%' and type = 0 group by user_id";        $fangke01= $db -> selectrow($fangke_sql01);        $fangke_sql02 = "select id from lkt_record where store_id = '$store_id' and add_date like '$day_1%' and type = 0 group by user_id";        $fangke02= $db -> selectrow($fangke_sql02);        if($fangke02 > 0){            $fangkebizhi = round(($fangke01-$fangke02)/$fangke02 *100 , 2)."%";        }else{                        $fangkebizhi = '0';        }        //本月        $fangke_sql03 = "select id from lkt_record where store_id = '$store_id' and add_date like '$mon%' and type = 0 group by user_id";        $fangke03= $db -> selectrow($fangke_sql03);        //订单统计        $order_sql01 = "select id from lkt_order where store_id = '$store_id' and add_time like '$today%'  and status > 0 and status not in(0,7,4,11) and pay_time != '' ";        $order01= $db -> selectrow($order_sql01);//今天有效订单数        $order_sql02 = "select id from lkt_order where store_id = '$store_id' and add_time like '$day_1%' and status > 0 and status not in(0,7,4,11) and pay_time != '' ";        $order02= $db -> selectrow($order_sql02);//1天前有效订单数        $order_sql03 = "select id from lkt_order where store_id = '$store_id' and add_time like '$day_2%' and status > 0 and status not in(0,7,4,11) and pay_time != '' ";//2天前有效订单数        $order03= $db -> selectrow($order_sql03);        $order_sql04 = "select id from lkt_order where store_id = '$store_id' and add_time like '$day_3%' and status > 0 and status not in(0,7,4,11) and pay_time != '' ";//3天前有效订单数        $order04= $db -> selectrow($order_sql04);        $order_sql05 = "select id from lkt_order where store_id = '$store_id' and add_time like '$day_4%' and status > 0 and status not in(0,7,4,11) and pay_time != '' ";//4天前有效订单数        $order05= $db -> selectrow($order_sql05);        $order_sql06 = "select id from lkt_order where store_id = '$store_id' and add_time like '$day_5%' and status > 0 and status not in(0,7,4,11) and pay_time != '' ";//5天前有效订单数        $order06= $db -> selectrow($order_sql06);        $order_sql07 = "select id from lkt_order where store_id = '$store_id' and add_time like '$day_6%' and status > 0 and status not in(0,7,4,11) and pay_time != '' ";//4天前有效订单数        $order07= $db -> selectrow($order_sql07);        $sql_uploadImg = "select * from lkt_config where store_id = '$store_id'";        $r_sql_uploadImg = $db->select($sql_uploadImg);        if($r_sql_uploadImg){            $uploadImg = $r_sql_uploadImg[0]->uploadImg; // 图片上传位置        }else{            $uploadImg = '../LKT/image';        }        $request->setAttribute("uploadImg",$uploadImg);//--待付款        $request->setAttribute("version",$version);        $request->setAttribute("dfk",$dfk);//--待付款         $request->setAttribute("dp",$dp);//--待发货        $request->setAttribute("yth",$yth);//--待收货        $request->setAttribute("pj",$pj);//评价订单         $request->setAttribute("th",$th);//退货订单        $request->setAttribute("wc",$wc);//完成订单         $request->setAttribute("day_yy",$day_yy); //当日的营业额        $request->setAttribute("yes_yy",$yes_yy); //昨日的营业额        $request->setAttribute("yingye_day",$yingye_day);//当日的营业额百分比        $request->setAttribute("daydd",$daydd);//当日的总订单        $request->setAttribute("yesdd",$yesdd);//前日的总订单        $request->setAttribute("dingdan_day",$dingdan_day);//当日的订单百分比        $request->setAttribute("tm01",$tm01);//这个月的营业额        $request->setAttribute("tm",$tm);//这个月的总订单        $request->setAttribute("tm02",$tm02);//累计营业额        $request->setAttribute("leiji_dd",$leiji_dd);//累计订单数        $request->setAttribute("user_num01",$user_num01);//今天会员注册数        $request->setAttribute("user_num02",$user_num02);//1天前会员注册数        $request->setAttribute("user_num03",$user_num03);//2天前会员注册数        $request->setAttribute("user_num04",$user_num04);//3天前会员注册数        $request->setAttribute("user_num05",$user_num05);//4天前会员注册数        $request->setAttribute("user_num06",$user_num06);//5天前会员注册数        $request->setAttribute("user_num07",$user_num07);//6天前会员注册数        $request->setAttribute("today",$today1);//今天日期        $request->setAttribute("day_show_1",$day_show_1);//1天前日期        $request->setAttribute("day_show_2",$day_show_2);//2天前日期        $request->setAttribute("day_show_3",$day_show_3);//3天前日期           $request->setAttribute("day_show_4",$day_show_4);//4天前日期        $request->setAttribute("day_show_5",$day_show_5);//5天前日期        $request->setAttribute("day_show_6",$day_show_6);//6天前日期        $request->setAttribute("res_notice",$res_notice);//公告        $request->setAttribute("user_num",$user_num);//会员总数        //访客人数        $request->setAttribute("fangke",$fangke);//fangke总数        $request->setAttribute("fangke01",$fangke01);//        $request->setAttribute("fangke02",$fangke02);//        //本月        $request->setAttribute("fangke03",$fangke03);//fangke总数        $request->setAttribute("fangkebizhi",$fangkebizhi);//fangke比值        //订单统计        $request->setAttribute("order01",$order01);//今天有效订单数        $request->setAttribute("order02",$order02);//1天前有效订单数        $request->setAttribute("order03",$order03);//2天前有效订单数        $request->setAttribute("order04",$order04);//3天前有效订单数        $request->setAttribute("order05",$order05);//4天前有效订单数        $request->setAttribute("order06",$order06);//5天前有效订单数        $request->setAttribute("order07",$order07);//6天前有效订单数        return View :: INPUT;    }    public function execute(){    }    public function getRequestMethods(){        return Request :: NONE;    }    function httpsRequest($url, $data=null) {        // 1.初始化会话        $ch = curl_init();        // 2.设置参数: url + header + 选项        // 设置请求的url        curl_setopt($ch, CURLOPT_URL, $url);        // 保证返回成功的结果是服务器的结果        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);        // https请求 不验证证书和hosts        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, FALSE);        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, FALSE);        curl_setopt($ch,CURLOPT_USERAGENT,"Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; .NET CLR 1.1.4322; .NET CLR 2.0.50727)"); //模拟浏览器代理        if(!empty($data)) {            // 发送post请求            curl_setopt($ch, CURLOPT_POST, 1);            // 设置发送post请求参数数据            curl_setopt($ch, CURLOPT_POSTFIELDS, $data);        }        // 3.执行会话; $result是微信服务器返回的JSON字符串        $result = curl_exec($ch);        // 4.关闭会话        curl_close($ch);        return $result;    }    public function upgrade()    {        $db=DBAction::getInstance();        $request = $this->getContext()->getRequest();        $version = LKT_VERSION;        https://open.laiketui.com/a15a744a5ca77d41baa9d4f272f45dfd/LKT/index.php?module=api&action=upgrade&type=2&software_version=0&version='.$version;        $vres = $this -> httpsRequest($url,$version);        $aaa = json_decode($vres);        $status = $aaa->status;        $lkt_web_version = $aaa->version;        $download = $request->getParameter('download'); // 下载更新包        if($download){            //校验版本            if($version < $lkt_web_version){                //判断是否下载过                if(is_file('../lkt_update_'.$lkt_web_version.'.zip')){                    echo "1";                }else{                    $down_url = $aaa->url;                    $file_res = $this->curlDownFile($down_url,'../','lkt_update_'.$lkt_web_version.'.zip');                    if($file_res){                        echo "1";                    }else{                        echo "0";                    }                }            }else{                echo "0";            }            exit;        }        if($version != $lkt_web_version){            $detail = '<b style="color:#f30;font-size:16px;padding:10px 0;display: inline-block;">紧急安全问题修复,强烈推荐升级到最新版!升级前注意备份.</b><br> #### update:<br> - 安全漏洞修复：文件越权读取漏洞紧急修复，iis6配置不当导致安全问题优化<br> - 文件通用选择，支持跨域，允许第三方调用<br> - tar解压，文件名过长兼容处理(路径大于100字符处理<br> - 图片预览大图处理；生成多级缩略图<br> - 权限组开启了文件下载权限，对应开启外链功能<br> - ace更新到1.29，支持emoji；emmt扩展加载机制优化<br> - 编辑器markdown多光标编辑，支持关联工具栏快捷功能<br> - 其他优化：文件名超出部分...表示；正在上传、远程下载关闭页面提醒<br> ';            $arrayName = array('status' => 1,'version' => $version,'lkt_web_version' => $lkt_web_version,'detail' => $detail);            echo json_encode($arrayName);        }else{            $arrayName = array('status' => 0,'version' => $version);            echo json_encode($arrayName);        }        exit;    }    /**     * @param string $down_url 下载文件地址     * @param string $save_path 下载文件保存目录     * @param string $filename 下载文件保存名称     * @return bool     */    function curlDownFile($down_url, $save_path = '', $filename = '') {        if (trim($down_url) == '') {            return false;        }        if (trim($save_path) == '') {            $save_path = '../';        }        //创建保存目录        if (!file_exists($save_path) && !mkdir($save_path, 0777, true)) {            return false;        }        if (trim($filename) == '') {            $img_ext = strrchr($down_url, '.');            $img_exts = array('.zip');            if (!in_array($img_ext, $img_exts)) {                return false;            }            $filename = time() . $img_ext;        }        // curl下载文件        $ch = curl_init();        $timeout = 5;        curl_setopt($ch, CURLOPT_URL, $down_url);        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);        // https请求 不验证证书和hosts        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, FALSE);        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, FALSE);        curl_setopt($ch,CURLOPT_USERAGENT,"Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; .NET CLR 1.1.4322; .NET CLR 2.0.50727)"); //模拟浏览器代理        curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, $timeout);        $file = curl_exec($ch);        curl_close($ch);        // 保存文件到制定路径        // file_put_contents($filename, $file);        //保存文件        ob_start ();        // $headfile = ob_get_contents ();        ob_end_clean ();        //保存文件        $res = fopen($save_path.$filename,'w+');        fwrite($res,$file);        fclose($res);        unset($file, $url);        return true;    }}?>