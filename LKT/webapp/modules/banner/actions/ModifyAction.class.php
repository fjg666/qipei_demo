<?php/** * [Laike System] Copyright (c) 2018 laiketui.com * Laike is not a free software, it under the license terms, visited http://www.laiketui.com/ for more details. */require_once(MO_LIB_DIR . '/DBAction.class.php');require_once(MO_LIB_DIR . '/ServerPath.class.php');require_once(MO_LIB_DIR . '/Tools.class.php');require_once(MO_LIB_DIR . '/JurisdictionAction.class.php');require_once(MO_LIB_DIR . '/LaiKeLogUtils.class.php');class ModifyAction extends Action {    /**     * <p>Copyright (c) 2018-2019</p>     * <p>Company: www.laiketui.com</p>     * @author 段宏波     * @date 2018/12/12  18:54     * @version 1.0     */	public function getDefaultView() {        $db = DBAction::getInstance();        $request = $this->getContext()->getRequest();        $store_id = $this->getContext()->getStorage()->read('store_id');        // 接收信息        $id = intval($request->getParameter("id")); // 轮播图id        // 根据轮播图id，查询轮播图信息        $sql = "select * from lkt_banner where store_id = '$store_id' and id = '$id'";        $r = $db->select($sql);        $image = ServerPath::getimgpath($r[0]->image,$store_id);  // 图片        $open_type = $r[0]->open_type; // 跳转类型        $page_url = $r[0]->url; // 路径        $parameter = trim(strrchr($page_url, '='),'='); // 参数        require_once(MO_LIB_DIR . '/front.class.php');        $list = array();        // 获前端页面地址        foreach ($front as $k => $v){            if($v['status']){ // 判断该页面是否支持跳转                $list[] = (object)$v;            }        }        foreach ($list as $k => $v){            if($open_type == $v->url){                $parameter_status = $v->parameter_status; // 前端所需参数状态                $parameter1 = $v->parameter; // 前端所需参数            }        }        $request->setAttribute('id', $id);        $request->setAttribute("image",$image);        $request->setAttribute("open_type",$open_type);        $request->setAttribute("page_url",$page_url);        $request->setAttribute("parameter",$parameter);        $request->setAttribute("parameter1",$parameter1);        $request->setAttribute("parameter_status",$parameter_status);        $request->setAttribute("list",$list);        return View :: INPUT;	}    /**     * <p>Copyright (c) 2018-2019</p>     * <p>Company: www.laiketui.com</p>     * @author 段宏波     * @date 2018/12/12  18:54     * @version 1.0     */	public function execute(){        $db = DBAction::getInstance();        $request = $this->getContext()->getRequest();        $store_id = $this->getContext()->getStorage()->read('store_id');        $admin_name = $this->getContext()->getStorage()->read('admin_name');        $top_type = $this->getContext()->getStorage()->read('store_type');        // 接收数据        $id = intval($request->getParameter('id'));        $open_type = addslashes(trim($request->getParameter('open_type'))); // 跳转类型        $parameter = addslashes(trim($request->getParameter('parameter'))); // 参数        $url = addslashes(trim($request->getParameter('url'))); // 路径        $image =addslashes($request->getParameter('pic_url')); // 图片        $lktlog = new LaiKeLogUtils("common/banner.log");        $JurisdictionAction = new JurisdictionAction();        // 1.开启事务        $db->begin();        if($image){            $image = preg_replace('/.*\//','',$image);        }else{            echo json_encode(array('code'=>0,'msg'=>'图片不能为空！'));            exit();        }        // 获前端页面地址        require_once(MO_LIB_DIR . '/front.class.php');        foreach ($front as $k => $v){            if($v['url'] == $open_type){                $parameter1 = $v['parameter']; // 前端所需参数                $parameter_status = $v['parameter_status']; // 前端所需参数状态            }        }        if($parameter_status){ // 前端跳转必须携带参数            if($parameter){ //商品分类id或者商品的id                if($parameter1 == 'cid'){//商品列表id                    $sql1 = "select cid,pname,img,bg from lkt_product_class where store_id = $store_id and recycle = 0 and sid=0 and cid = $parameter";                    $res1 = $db->select($sql1);                    if(!$res1){                        echo json_encode(array('status' =>'该分类不存在！' ));exit;                    }                }else if($parameter1 == 'productId'){//商品id                    $sql2 = "select id from lkt_product_list where store_id = $store_id and id = $parameter";                    $res2 = $db->select($sql2);                    if(!$res2){                       echo json_encode(array('status' =>'该商品不存在！' ));exit;                    }                }            }else{                echo json_encode(array('status' =>'参数不能为空！' ));exit;            }        }        // 修改轮播图        $sql = "update lkt_banner set image = '$image',open_type = '$open_type',url = '$url',add_date = CURRENT_TIMESTAMP where store_id = '$store_id' and id = '$id' and type ='$top_type'";        $r = $db->update($sql);        if($r == -1){            $JurisdictionAction->admin_record($store_id,$admin_name,'修改轮播图ID为'.$id.'失败',2);            $Log_content = __METHOD__ . '->' . __LINE__ . ' 修改轮播图ID为'.$id.'失败,类型为 '.$top_type;            $lktlog->customerLog($Log_content);            $db->rollback();            echo json_encode(array('status'=>'修改失败！'));            exit();        }else{            $JurisdictionAction->admin_record($store_id,$admin_name,'修改轮播图ID为'.$id,2);            $Log_content = __METHOD__ . '->' . __LINE__ . ' 修改轮播图ID为'.$id.'成功,类型为 '.$top_type;            $lktlog->customerLog($Log_content);            $db->commit();            echo json_encode(array('suc'=>1,'status'=>'修改成功！'));            exit();        }	}	public function getRequestMethods(){		return Request :: POST;	}}?>