<?phprequire_once(MO_LIB_DIR . '/DBAction.class.php');require_once(MO_LIB_DIR . '/Tools.class.php');require_once(MO_LIB_DIR . '/JurisdictionAction.class.php');require_once(MO_LIB_DIR . '/LaiKeLogUtils.class.php');class AddAction extends Action {    /**     * <p>Copyright (c) 2018-2019</p>     * <p>Company: www.laiketui.com</p>     * @author 段宏波     * @date 2018/12/12  18:54     * @version 1.0     */	public function getDefaultView() {        $db = DBAction::getInstance();        $request = $this->getContext()->getRequest();        $m = addslashes(trim($request->getParameter('m')));        if($m){            $this->$m();        }        // 获前端页面地址        require_once(MO_LIB_DIR . '/front.class.php');        $list = array();        foreach ($front as $k => $v){            if($v['status']){ // 判断该页面是否支持跳转                $list[] = (object)$v;            }        }        $request->setAttribute('list', $list);        return View :: INPUT;	}    /**     * <p>Copyright (c) 2018-2019</p>     * <p>Company: www.laiketui.com</p>     * @author 段宏波     * @date 2018/12/12  18:54     * @version 1.0     */	public function execute(){		$db = DBAction::getInstance();		$request = $this->getContext()->getRequest();        $store_id = $this->getContext()->getStorage()->read('store_id');        $admin_name = $this->getContext()->getStorage()->read('admin_name');        $top_type = $this->getContext()->getStorage()->read('store_type');        // 接收数据        $open_type = addslashes(trim($request->getParameter('open_type'))); // 跳转类型        $parameter = addslashes(trim($request->getParameter('parameter'))); // 参数        $url = addslashes(trim($request->getParameter('url'))); // 路径        $image =addslashes($request->getParameter('pic_url')); // 图片        $JurisdictionAction = new JurisdictionAction();        $lktlog = new LaiKeLogUtils("common/banner.log");        // 1.开启事务        $db->begin();        if($image){            $image = preg_replace('/.*\//','',$image);        }else{            echo json_encode(array('status' =>'轮播图不能为空！' ));exit;        }        // 获前端页面地址        require_once(MO_LIB_DIR . '/front.class.php');        foreach ($front as $k => $v){            if($v['url'] == $open_type){                $parameter1 = $v['parameter']; // 前端所需参数                $parameter_status = $v['parameter_status']; // 前端所需参数状态            }        }        if($parameter_status){ // 前端跳转必须携带参数            if($parameter){ //商品分类id或者商品的id                if($parameter1 == 'cid'){//商品列表id                    $sql1 = "select cid,pname,img,bg from lkt_product_class where store_id = $store_id and recycle = 0 and sid=0 and cid = $parameter";                    $res1 = $db->select($sql1);                    if(!$res1){                        echo json_encode(array('status' =>'该分类不存在！' ));exit;                    }                }else if($parameter1 == 'productId'){//商品id                    $sql2 = "select id from lkt_product_list where store_id = $store_id and id = $parameter";                    $res2 = $db->select($sql2);                    if(!$res2){                       echo json_encode(array('status' =>'该商品不存在！' ));exit;                    }                }            }else{                echo json_encode(array('status' =>'参数不能为空！' ));exit;            }        }        // 查询最大的排序号        $sql = "select MAX(sort) as sort from lkt_banner where store_id = '$store_id' ";        $rr = $db->select($sql);        $sort = $rr[0]->sort;        $sort= $sort +1 ;        // 添加        $sql = "insert into lkt_banner(store_id,open_type,image,url,sort,type,add_date) values('$store_id','$open_type','$image','$url','$sort','$top_type',CURRENT_TIMESTAMP) ";        $r = $db->insert($sql);        if($r == -1){            $JurisdictionAction->admin_record($store_id,$admin_name,'添加轮播图失败',1);            $Log_content = __METHOD__ . '->' . __LINE__ . ' 添加轮播图失败,类型为 '.$top_type;            $lktlog->customerLog($Log_content);            $db->rollback();            echo json_encode(array('status'=>'添加失败！'));            exit();        }else{            $JurisdictionAction->admin_record($store_id,$admin_name,'添加轮播图',1);            $Log_content = __METHOD__ . '->' . __LINE__ . ' 添加轮播图成功,类型为 '.$top_type;            $lktlog->customerLog($Log_content);            $db->commit();            echo json_encode(array('suc'=>1,'status'=>'添加成功！'));            exit();        }	    return;	}	public function getRequestMethods(){		return Request :: POST;	}	public function open_type(){        $request = $this->getContext()->getRequest();        $obj = addslashes(trim($request->getParameter('obj')));        require_once(MO_LIB_DIR . '/front.class.php');        foreach ($front as $k => $v){            if($v['url'] == $obj){                $url = $v['url'];                $parameter_status = $v['parameter_status'];                $parameter = $v['parameter'];            }        }        echo json_encode(array('parameter_status' =>$parameter_status,'url' =>$url,'parameter' =>$parameter));exit;    }}?>